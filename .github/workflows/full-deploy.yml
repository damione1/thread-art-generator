name: Full Deployment (Infrastructure + Application)

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy'
        required: true
        default: 'staging'
        type: choice
        options:
          - staging
          - production
      deploy_infrastructure:
        description: 'Deploy infrastructure (Terraform)'
        required: true
        default: true
        type: boolean
      deploy_application:
        description: 'Deploy application (Build & Deploy)'
        required: true
        default: true
        type: boolean

jobs:
  infrastructure:
    name: Deploy Infrastructure
    if: ${{ github.event.inputs.deploy_infrastructure == 'true' }}
    uses: ./.github/workflows/terraform-deploy.yml
    with:
      environment: ${{ github.event.inputs.environment }}
    secrets: inherit

  application:
    name: Deploy Application  
    if: ${{ github.event.inputs.deploy_application == 'true' }}
    needs: infrastructure
    # Run even if infrastructure was skipped (when deploy_infrastructure is false)
    if: ${{ always() && (needs.infrastructure.result == 'success' || needs.infrastructure.result == 'skipped') }}
    uses: ./.github/workflows/build-deploy.yml
    with:
      environment: ${{ github.event.inputs.environment }}
    secrets: inherit

  summary:
    name: Deployment Summary
    runs-on: ubuntu-latest
    needs: [infrastructure, application]
    if: always()
    steps:
      - name: Deployment Summary
        run: |
          echo "## 🚀 Full Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Environment:** ${{ github.event.inputs.environment }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ github.event.inputs.deploy_infrastructure }}" == "true" ]; then
            if [ "${{ needs.infrastructure.result }}" == "success" ]; then
              echo "✅ **Infrastructure Deployment:** Success" >> $GITHUB_STEP_SUMMARY
            else
              echo "❌ **Infrastructure Deployment:** ${{ needs.infrastructure.result }}" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "⏩ **Infrastructure Deployment:** Skipped" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ "${{ github.event.inputs.deploy_application }}" == "true" ]; then
            if [ "${{ needs.application.result }}" == "success" ]; then
              echo "✅ **Application Deployment:** Success" >> $GITHUB_STEP_SUMMARY
            else
              echo "❌ **Application Deployment:** ${{ needs.application.result }}" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "⏩ **Application Deployment:** Skipped" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Timestamp:** $(date -u)" >> $GITHUB_STEP_SUMMARY